
# ADR-001: Выбор брокера сообщений для платформы ProDvor

**Статус:** Принято

**Дата:** 2024-07-31

## Контекст

Платформа "ProDvor" требует надежной, масштабируемой и производительной системы для асинхронного обмена сообщениями между микросервисами. Ключевые требования:
1.  **Масштабируемость:** Система должна быть рассчитана на поддержку до **80 миллионов пользователей**.
2.  **Надежность:** Гарантированная доставка сообщений для чатов, уведомлений и системных событий.
3.  **Real-time чаты:** Обеспечение низкой задержки для миллионов одновременных чат-сессий.
4.  **Будущие требования:** Архитектура должна быть готова к внедрению **стриминговых сервисов (трансляций матчей)** и сложной аналитики в реальном времени.
5.  **Персистентность:** Сообщения должны сохраняться для оффлайн-доставки и возможности повторного чтения (event sourcing).

## Принятое решение

Мы приняли решение использовать **Apache Kafka** в качестве основного брокера сообщений и стриминговой платформы.

## Обоснование

Kafka выбрана как стратегическое решение, которое наилучшим образом соответствует долгосрочным целям проекта и требованиям к масштабированию.

### Рассмотренные варианты

#### 1. NATS / NATS JetStream

-   **Плюсы:**
    -   Очень высокая производительность и низкая задержка.
    -   Простота развертывания и эксплуатации.
    -   Отлично подходит для стандартных сценариев pub/sub и request/reply.
-   **Минусы:**
    -   Менее мощные возможности по обработке потоков по сравнению с Kafka.
    -   Экосистема меньше, чем у Kafka.
    -   Может не справиться с аналитическими нагрузками и сложным процессингом стримов в будущем.
-   **Вывод:** Идеален для прототипов и систем среднего размера, но **недостаточен** для заявленных 80 млн пользователей и функционала трансляций.

#### 2. RabbitMQ

-   **Плюсы:**
    -   Гибкая маршрутизация сообщений (AMQP).
    -   Зрелый и надежный продукт с хорошей документацией.
    -   Поддержка различных протоколов.
-   **Минусы:**
    -   Более низкая пропускная способность (throughput) по сравнению с Kafka при очень высоких нагрузках.
    -   Сложнее в кластеризации и масштабировании, чем Kafka.
    -   Не является стриминговой платформой, что усложнит реализацию трансляций.
-   **Вывод:** Отличный универсальный брокер, но **уступает Kafka в чистой производительности** на больших масштабах и не имеет нативных возможностей для стриминга.

#### 3. Apache Kafka (Выбранный вариант)

-   **Плюсы:**
    -   **Экстремальная масштабируемость:** Спроектирован для обработки триллионов сообщений в день, что идеально для 80 млн пользователей.
    -   **Стриминговая платформа:** Нативная поддержка обработки потоков (Kafka Streams, ksqlDB) является ключевым преимуществом для будущего функционала трансляций.
    -   **Гарантированная персистентность и отказоустойчивость:** Данные хранятся в распределенном логе, что обеспечивает надежность и возможность повторного чтения событий.
    -   **Огромная экосистема:** Промышленный стандарт с множеством коннекторов и инструментов.
-   **Минусы:**
    -   **Более высокий порог входа:** Сложнее в настройке и управлении, чем NATS или RabbitMQ.
    -   **Требует больше ресурсов:** Работа с ZooKeeper (в старых версиях) или KRaft добавляет операционной сложности.

## Последствия

-   **Положительные:**
    -   Мы закладываем фундамент, способный выдержать сверхвысокие нагрузки и будущие требования.
    -   Упрощается внедрение аналитических систем и data lake в будущем.
    -   Архитектура готова к реализации real-time стриминга.
-   **Отрицательные:**
    -   Увеличение сложности на этапе разработки и развертывания.
    -   Потребуется больше экспертизы в команде для поддержки и оптимизации Kafka-кластера.
