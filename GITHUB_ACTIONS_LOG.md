# Лог Рабочих Решений для GitHub Actions

Этот документ служит для фиксации проверенных и работающих решений, примененных к CI/CD пайплайну (`.github/workflows/main.yml`) и связанным с ним файлам (`Dockerfile`, `docker-compose.ci.yml`).

## 1. Проблема: Prisma Client не генерируется в Docker

- **Симптомы:** ~360 ошибок TypeScript вида `Property '...' does not exist on type 'PrismaService'` или `Module '"@prisma/client"' has no exported member '...'`.
- **Причина:** Неправильный порядок команд в `Dockerfile`. Команда `COPY . .` перезаписывала сгенерированный `PrismaClient` в `node_modules` перед сборкой.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Использовать многоэтапный Docker-файл со строгой последовательностью команд на этапе `builder`:
  1.  `COPY` **только** файлов манифеста (`package.json`, `pnpm-workspace.yaml`, `pnpm-lock.yaml`) и `package.json` **каждого** воркспейса.
  2.  `COPY` схемы Prisma (`backend/prisma/schema.prisma`).
  3.  `RUN pnpm install`. Этот шаг установит все зависимости и запустит `postinstall` скрипт, который содержит `prisma generate`.
  4.  `COPY . .` **ПОСЛЕ** установки зависимостей, чтобы скопировать исходный код, не затрагивая `node_modules`.
  5.  `RUN pnpm ... build`.

## 2. Проблема: `pnpm: not found` в Docker

- **Симптомы:** Ошибка `pnpm: not found` на любом шаге `RUN pnpm ...`.
- **Причина:** Базовый образ `node` не имеет глобально установленного `pnpm`. Его нужно активировать через `corepack`.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Добавлять `RUN corepack enable` в **каждую** стадию (`builder`, `pruner`) Docker-файла, где используется `pnpm`.

## 3. Проблема: `pnpm deploy` не работает с воркспейсами

- **Симптомы:** Ошибка `ERR_PNPM_DEPLOY_NONINJECTED_WORKSPACE` при выполнении `pnpm deploy`.
- **Причина:** Начиная с v10, `pnpm deploy` изменила поведение по умолчанию.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Использовать флаг `--legacy` для возврата к старому, предсказуемому поведению. Команда должна выглядеть как `pnpm deploy --legacy ...`.

## 4. Проблема: `pnpm deploy` требует пустую директорию

- **Симптомы:** Ошибка `ERR_PNPM_DEPLOY_DIR_NOT_EMPTY` при выполнении `pnpm deploy`.
- **Причина:** Попытка запустить `pnpm deploy` в директорию, в которую уже были скопированы файлы (например, `dist`).
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Стадия `pruner` должна начинаться с чистого `WORKDIR`. Сначала копируются только `package.json`, `pnpm-workspace.yaml`, затем скомпилированный `dist` из `builder`, и только потом выполняется `pnpm deploy`, который создаст `node_modules` рядом с `dist`.

## 5. Проблема: `pnpm deploy` требует указания целевой директории

- **Симптомы:** Ошибка `ERR_PNPM_INVALID_DEPLOY_TARGET`.
- **Причина:** Команда `pnpm deploy` требует обязательный аргумент — путь, куда разворачивать зависимости.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Всегда указывать целевую директорию. Например, `pnpm deploy --legacy --prod --filter ... ./` для установки в текущую `WORKDIR`.