# Лог Рабочих Решений для GitHub Actions

Этот документ служит для фиксации проверенных и работающих решений, примененных к CI/CD пайплайну (`.github/workflows/main.yml`) и связанным с ним файлам (`Dockerfile`, `docker-compose.ci.yml`).

## ✅ Принцип №1: Полная имитация локального окружения

- **Проблема:** Постоянные расхождения между локальной средой разработки и средой в GitHub Actions. Ошибки, которые не воспроизводятся локально, появляются в CI.
- **Причина:** Попытки создать "оптимизированный" CI-пайплайн, который отличается от `docker-compose.yml`. Это приводило к проблемам с `pnpm`, `Prisma` и путями.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** Отказаться от сложных, кастомных CI-шагов. CI-пайплайн должен **полностью имитировать** локальный запуск через `docker-compose`. Он должен:
  1.  Использовать `docker-compose.yml` и файл переопределений `docker-compose.ci.yml`.
  2.  Собирать все образы с помощью `docker compose build`.
  3.  Запускать все сервисы в фоновом режиме через `docker compose up -d`.
  4.  Использовать `healthcheck` в `docker-compose.yml` и циклы `until` в CI для ожидания полной готовности сервисов (особенно баз данных).
  5.  Выполнять миграции через `docker compose run`, что гарантирует их запуск в том же окружении, что и основной сервис.
  6.  После выполнения всех тестов и проверок, корректно останавливать все сервисы через `docker compose down -v`.

Этот подход гарантирует, что если сборка проходит в CI, она с высокой вероятностью будет работать и в продакшене.

## ✅ Принцип №2: Dockerfile должен быть самодостаточным

- **Проблема:** Ошибки, связанные с отсутствием Prisma Client, зависимостей или неправильной сборкой.
- **Причина:** Попытки выполнять ключевые шаги сборки (установка зависимостей, генерация кода) вне `Dockerfile`, прямо в CI-воркфлоу. Это нарушает принцип инкапсуляции.
- **Рабочее решение (✅ ЗАФИКСИРОВАНО):** `Dockerfile` для каждого сервиса (frontend, backend) должен быть **полностью самодостаточным**. Вся логика, необходимая для создания готового к запуску образа, инкапсулируется в нем. Это включает:
  1.  Установку системных зависимостей (`openssl`).
  2.  Установку `pnpm` через `corepack enable`.
  3.  Копирование манифестов и `schema.prisma`.
  4.  Установку всех зависимостей (`pnpm install`).
  5.  Генерацию Prisma Client (через `postinstall` или явным вызовом `pnpm prisma:generate`).
  6.  Сборку приложения (`pnpm build`).

CI-пайплайн только вызывает `docker compose build`, он не вмешивается во внутренние шаги сборки.
