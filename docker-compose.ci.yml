# This file overrides the default docker-compose.yml for CI environments.

services:
  migrations:
    build:
      context: .
      dockerfile: backend/Dockerfile
      target: migrations
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ./.env
    networks:
      - prodvor-network
    restart: "no"

  backend:
    image: prodvor/backend:latest
    command: node dist/main.js
    depends_on:
      migrations:
        condition: service_completed_successfully
    env_file:
      - ./.env
    ports:
      - "3001:3001"
    networks:
      - prodvor-network
    restart: on-failure

  frontend:
    image: prodvor/frontend:latest
    command: pnpm start
    depends_on:
      - backend
    env_file:
      - ./.env
    ports:
      - "9002:9002"
    networks:
      - prodvor-network

  keycloak:
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: >
        bash -c "exec 9<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\r\nhost: localhost\r\nConnection: close\r\n\r\n' >&9 && head -n 1 <&9 | grep 'HTTP/1.1 200'"
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
