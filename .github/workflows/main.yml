name: Docker Compose CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create .env file from secrets
        env:
          POSTGRES_USER_SECRET: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD_SECRET: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB_SECRET: ${{ secrets.POSTGRES_DB }}
          PGADMIN_DEFAULT_EMAIL_SECRET: ${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD_SECRET: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
          KC_BOOTSTRAP_ADMIN_USERNAME_SECRET: ${{ secrets.KC_BOOTSTRAP_ADMIN_USERNAME }}
          KC_BOOTSTRAP_ADMIN_PASSWORD_SECRET: ${{ secrets.KC_BOOTSTRAP_ADMIN_PASSWORD }}
          KC_DB_USERNAME_SECRET: ${{ secrets.KC_DB_USERNAME }}
          KC_DB_PASSWORD_SECRET: ${{ secrets.KC_DB_PASSWORD }}
          KC_DB_DATABASE_SECRET: ${{ secrets.KC_DB_DATABASE }}
          KC_HOSTNAME_SECRET: localhost:8180
          KC_HOSTNAME_STRICT_SECRET: false
          KONG_ADMIN_LISTEN_SECRET: ${{ secrets.KONG_ADMIN_LISTEN }}
          KONG_PROXY_LISTEN_SECRET: ${{ secrets.KONG_PROXY_LISTEN }}
          KONG_PG_PASSWORD_SECRET: ${{ secrets.KONG_PG_PASSWORD }}
          RABBITMQ_DEFAULT_USER_SECRET: ${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASSWORD_SECRET: ${{ secrets.RABBITMQ_DEFAULT_PASSWORD }}
        run: |
          if [ -z "$POSTGRES_PASSWORD_SECRET" ]; then echo "::error::Required secret POSTGRES_PASSWORD is not set." >&2; exit 1; fi
          if [ -z "$RABBITMQ_DEFAULT_USER_SECRET" ]; then echo "::error::Required secret RABBITMQ_DEFAULT_USER is not set." >&2; exit 1; fi
          if [ -z "$RABBITMQ_DEFAULT_PASSWORD_SECRET" ]; then echo "::error::Required secret RABBITMQ_DEFAULT_PASSWORD is not set." >&2; exit 1; fi
          if [ -z "$KC_DB_PASSWORD_SECRET" ]; then echo "::error::Required secret KC_DB_PASSWORD is not set." >&2; exit 1; fi
          if [ -z "$KONG_PG_PASSWORD_SECRET" ]; then echo "::error::Required secret KONG_PG_PASSWORD is not set." >&2; exit 1; fi

          cat > .env <<EOF
          POSTGRES_USER=${POSTGRES_USER_SECRET:-postgres}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD_SECRET}
          POSTGRES_DB=${POSTGRES_DB_SECRET:-prodvor}
          PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL_SECRET:-admin@example.com}
          PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD_SECRET:-admin}
          KC_BOOTSTRAP_ADMIN_USERNAME=${KC_BOOTSTRAP_ADMIN_USERNAME_SECRET:-admin}
          KC_BOOTSTRAP_ADMIN_PASSWORD=${KC_BOOTSTRAP_ADMIN_PASSWORD_SECRET:-admin}
          KC_DB_USERNAME=${KC_DB_USERNAME_SECRET:-keycloak}
          KC_DB_PASSWORD=${KC_DB_PASSWORD_SECRET}
          KC_DB_DATABASE=${KC_DB_DATABASE_SECRET:-keycloak}
          KC_HOSTNAME=${KC_HOSTNAME_SECRET}
          KC_HOSTNAME_STRICT=${KC_HOSTNAME_STRICT_SECRET}
          KONG_ADMIN_LISTEN=${KONG_ADMIN_LISTEN_SECRET:-0.0.0.0:8001}
          KONG_PROXY_LISTEN=${KONG_PROXY_LISTEN_SECRET:-0.0.0.0:8000}
          KONG_PG_PASSWORD=${KONG_PG_PASSWORD_SECRET}
          RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER_SECRET}
          RABBITMQ_DEFAULT_PASSWORD=${RABBITMQ_DEFAULT_PASSWORD_SECRET}
          DATABASE_URL=postgresql://${POSTGRES_USER_SECRET:-postgres}:${POSTGRES_PASSWORD_SECRET}@db:5432/${POSTGRES_DB_SECRET:-prodvor}?schema=public
          REDIS_URL=redis://redis:6379
          KAFKA_BROKERS=kafka:9092
          KEYCLOAK_URL=http://keycloak:8080
          KEYCLOAK_REALM=prodvor
          KEYCLOAK_CLIENT_ID=prodvor-frontend
          RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER_SECRET}:${RABBITMQ_DEFAULT_PASSWORD_SECRET}@rabbitmq:5672
          NEXT_PUBLIC_BACKEND_URL=http://kong:8000
          PGPASSWORD=${POSTGRES_PASSWORD_SECRET}
          EOF

      - name: Clean up previous run
        run: docker compose down -v --remove-orphans

      - name: Build and Tag Keycloak Image
        run: docker build -t prodvor/keycloak:ci -f backend/Dockerfile.keycloak backend

      - name: Launch all services
        run: docker compose --verbose -f docker-compose.yml -f docker-compose.ci.yml up -d --wait

      - name: Show Keycloak logs
        run: docker compose --verbose logs keycloak

      - name: Run Prisma migrations
        run: docker compose --verbose exec backend npm run prisma:migrate:deploy

      - name: Check container statuses
        run: docker compose --verbose ps

      - name: Show Main DB logs on failure
        if: failure()
        run: docker compose --verbose logs db

      - name: Show Keycloak DB logs on failure
        if: failure()
        run: docker compose --verbose logs keycloak-db

      - name: Show backend logs on failure
        if: failure()
        run: docker compose --verbose logs backend

      - name: Show frontend logs on failure
        if: failure()
        run: docker compose --verbose logs frontend

      - name: Show Keycloak logs on failure
        if: failure()
        run: docker compose --verbose logs keycloak

      - name: Show Kafka logs on failure
        if: failure()
        run: docker compose --verbose logs kafka

      - name: Install dependencies
        run: npm install

      - name: Lint code
        run: |
          npm run lint --workspace=frontend
          npm run lint --workspace=backend

      - name: Typecheck code
        run: |
          npm run typecheck --workspace=frontend
          npm run typecheck --workspace=backend

      - name: Build frontend
        run: npm run build --workspace=frontend

      - name: Tear down
        if: always()
        run: docker compose --verbose -f docker-compose.yml -f docker-compose.ci.yml down -v
