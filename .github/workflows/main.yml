name: Docker Compose CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker CLI
        uses: docker/setup-docker-action@v4

      - name: Set up QEMU (для multi-platform, если нужно)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js and Corepack
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack (for pnpm)
        run: corepack enable

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: Create .env file
        run: |
          cat > .env <<EOF
          ... ваш .env ...
          EOF

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter prodvor-backend prisma:generate

      - name: Build all images
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml build

      - name: Launch all services in background
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d

      - name: Wait for DBs, migrations и Kong
        run: |
          # ... ваши ожидалки ...

      - name: Run Kong migrations
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm kong-migrations-ci

      - name: Run Prisma migrations (inside container)
        run: |
          unset PNPM_HOME PATH
          docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm migrations

      - name: Проверка доступности pnpm
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm migrations \
            sh -lc "which pnpm && pnpm -v"

      - name: Wait for Kong to be ready
        run: |
          # ... проверки Kong ...

      - name: Show logs on failure
        if: failure()
        run: |
          echo "::group::DB Logs"
          docker compose -f docker-compose.yml -f docker-compose.ci.yml logs db
          echo "::endgroup::"
          # ... далее остальные логгруппы ...

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
