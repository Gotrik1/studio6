
name: Docker Compose CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate secrets and create .env file
        run: |
          # Fail fast if critical secrets are missing
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then echo "::error::Required secret POSTGRES_PASSWORD is not set." >&2; exit 1; fi
          if [ -z "${{ secrets.RABBITMQ_DEFAULT_USER }}" ]; then echo "::error::Required secret RABBITMQ_DEFAULT_USER is not set." >&2; exit 1; fi
          if [ -z "${{ secrets.RABBITMQ_DEFAULT_PASSWORD }}" ]; then echo "::error::Required secret RABBITMQ_DEFAULT_PASSWORD is not set." >&2; exit 1; fi
          
          # Create .env file
          cat > .env <<EOF
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          PGADMIN_DEFAULT_EMAIL=${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD=${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
          KEYCLOAK_ADMIN=${{ secrets.KEYCLOAK_ADMIN }}
          KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
          KONG_ADMIN_LISTEN=${{ secrets.KONG_ADMIN_LISTEN }}
          KONG_PROXY_LISTEN=${{ secrets.KONG_PROXY_LISTEN }}
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}?schema=public
          REDIS_URL=redis://redis:6379
          KAFKA_BROKERS=kafka:9092
          KEYCLOAK_URL=http://keycloak:8080
          KEYCLOAK_REALM=prodvor
          KEYCLOAK_CLIENT_ID=prodvor-frontend
          RABBITMQ_DEFAULT_USER=${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASSWORD=${{ secrets.RABBITMQ_DEFAULT_PASSWORD }}
          RABBITMQ_URL=amqp://${{ secrets.RABBITMQ_DEFAULT_USER }}:${{ secrets.RABBITMQ_DEFAULT_PASSWORD }}@rabbitmq:5672
          NEXT_PUBLIC_BACKEND_URL=http://kong:8000
          PGPASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          EOF

      - name: Launch all services
        run: docker compose --env-file ./.env -f docker-compose.yml -f docker-compose.ci.yml up -d --build

      - name: Wait for Main DB to become healthy
        run: |
          for i in {1..20}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose ps -q db))
            echo "ðŸ” Attempt $i: main-db status = $status"
            if [ "$status" = "healthy" ]; then
              echo "âœ… main-db is healthy"
              exit 0
            elif [ "$status" = "unhealthy" ]; then
              echo "::error::âŒ main-db is unhealthy"
              docker compose logs db
              exit 1
            fi
            sleep 6
          done
          echo "::error::â³ main-db did not become healthy in time"
          docker compose logs db
          exit 1
      
      - name: Wait for Keycloak DB to become healthy
        run: |
          for i in {1..20}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose ps -q keycloak-db))
            echo "ðŸ” Attempt $i: keycloak-db status = $status"
            if [ "$status" = "healthy" ]; then
              echo "âœ… keycloak-db is healthy"
              exit 0
            elif [ "$status" = "unhealthy" ]; then
              echo "::error::âŒ keycloak-db is unhealthy"
              docker compose logs keycloak-db
              exit 1
            fi
            sleep 6
          done
          echo "::error::â³ keycloak-db did not become healthy in time"
          docker compose logs keycloak-db
          exit 1
      
      - name: Wait for Kong DB to become healthy
        run: |
          for i in {1..20}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose ps -q kong-db))
            echo "ðŸ” Attempt $i: kong-db status = $status"
            if [ "$status" = "healthy" ]; then
              echo "âœ… kong-db is healthy"
              exit 0
            elif [ "$status" = "unhealthy" ]; then
              echo "::error::âŒ kong-db is unhealthy"
              docker compose logs kong-db
              exit 1
            fi
            sleep 6
          done
          echo "::error::â³ kong-db did not become healthy in time"
          docker compose logs kong-db
          exit 1

      - name: Show Main DB logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs db

      - name: Show Keycloak DB logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs keycloak-db

      - name: Show Kong DB logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs kong-db
        
      - name: Show backend logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs backend

      - name: Install frontend dependencies
        run: npm install --workspace=frontend

      - name: Lint frontend
        run: npm run lint --workspace=frontend

      - name: Typecheck frontend
        run: npm run typecheck --workspace=frontend

      - name: Build frontend
        run: npm run build --workspace=frontend

      - name: Show frontend logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs frontend

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
